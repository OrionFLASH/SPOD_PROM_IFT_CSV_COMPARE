# Сравнение пар CSV-файлов (SPOD PROM IFT CSV Compare)

## 1. Формулировка задачи и техническое задание

### 1.1 Назначение

Программа предназначена для попарного сравнения одноимённых CSV-файлов, расположенных в двух каталогах (**ONE** и **TWO**). Один каталог считается **текущим** (исходная/старая версия данных), второй — **новым** (обновлённая версия). Результат работы — **три** Excel-файла (.xlsx) в каталоге **OUT**:

1. **IN_{префикс}_{таймштамп}.xlsx** — исходные загруженные данные: для каждого типа файла листы **ONE** и **TWO** (данные из каталогов ONE и TWO).
2. **MERGE_{префикс}_{таймштамп}.xlsx** — слияние по уникальному ключу: листы **MERGE** по каждому типу файла (все строки из обоих файлов, значения из нового подставляются поверх текущего там, где есть отличия).
3. **COMPARE_{префикс}_{таймштамп}.xlsx** — список изменений: листы **COMPARE** по каждому типу файла (ключи и колонки с правками, в формате трёх строк на правку: ONE, TWO, CHANGE).

Требования к входным данным:

- CSV с разделителем **точка с запятой** (`;`);
- кодировка **UTF-8**;
- первая строка — заголовки (названия колонок).

Программа должна быть **универсальной**: работать с любым набором колонок. Если в новом файле колонка удалена — в MERGE она остаётся, заголовок выделяется **красным**. Если колонка добавлена — она добавляется в MERGE, заголовок выделяется **салатовым**. Заголовки везде **жирные**, на листах включён **автофильтр**, закрепление областей задаётся в параметрах для каждого типа файла.

### 1.2 Техническое задание

- Загрузка всех указанных в конфигурации CSV из каталогов `IN/ONE` и `IN/TWO`.
- Для каждой пары файлов:
  - построение множества уникальных ключей (по заданному списку колонок `key_columns`);
  - формирование листа MERGE (все уникальные ключи, данные текущего файла, перезапись из нового где есть отличия);
  - формирование листа COMPARE (ключ, колонка, значение в текущем, значение в новом, место изменения в значении — при возможности).
- Обработка по возможности **параллельная** (несколько процессов).
- Выходные файлы: каталог **OUT**, три файла с именами **{тип}_{префикс}_{таймштамп}.xlsx**, где тип — `IN`, `MERGE` или `COMPARE`, таймштамп — год, месяц, день, час, минута.
- Использование только стандартной библиотеки Python и модулей, поставляемых с Python/Anaconda 3.10 (без `pip install` на целевой системе). Для записи xlsx используется **openpyxl** (часто уже есть в Anaconda; при отсутствии — `conda install openpyxl`).
- Аннотации типов, подробные комментарии и документация на русском языке.
- Каталоги **IN**, **OUT**, **log**/LOGS не должны попадать в репозиторий (указаны в `.gitignore`).

---

## 2. Подробное описание решения

### 2.1 Структура проекта

- **main.py** — единственный исполняемый файл: конфигурация, загрузка CSV, слияние по ключам, сравнение, запись Excel, логирование, при необходимости — многопроцессная обработка.
- **IN/ONE**, **IN/TWO** — каталоги с исходными CSV (имена файлов задаются в `INPUT_FILES`).
- **OUT** — каталог для сгенерированных xlsx (три файла: IN, MERGE, COMPARE).
- **log** — каталог для логов (формат имени: `DEBUG_compare_ГГГГММДД_ЧЧ.log`).

### 2.2 Алгоритм

1. **Параметры**  
   В начале `main.py` задаются: `BASE_DIR`, `FOLDER_ONE`, `FOLDER_TWO`, `CURRENT_FOLDER` (какой каталог считать текущим), `OUT_DIR`, `LOG_DIR`, `OUTPUT_FILE_PREFIX`, список `INPUT_FILES` (для каждого файла: имя, лист, ключевые колонки, ширина колонок, закрепление и т.д.).

2. **Поиск файлов**  
   Для каждой пары из `INPUT_FILES` ищется файл `file_one` в каталоге ONE и файл `file_two` в каталоге TWO. Имена могут различаться (например, старая и новая версия одного набора). Поддерживается разный регистр расширения (`.csv` / `.CSV`).

3. **Загрузка CSV**  
   Чтение в кодировке UTF-8, разделитель `;`. Первая строка — заголовки, остальные — строки данных (словарь по именам колонок).

4. **Ключ строки**  
   По полям `key_columns` строится кортеж значений — составной ключ. Уникальность строки в MERGE определяется по этому ключу.

5. **Слияние (MERGE)**  
   Объединяются все ключи из текущего и нового файла. Для каждого ключа берётся строка из текущего файла, затем для каждой колонки из нового файла значение подставляется поверх (если есть в новом). Колонки только из текущего файла в заголовке MERGE выделяются красным; только из нового — салатовым.

6. **Сравнение (COMPARE)**  
   При подстановке значения из нового файла, если оно отличается от текущего, в COMPARE добавляется запись: ключ, колонка, значение в текущем, значение в новом. Для текстовых значений делается попытка указать место изменения (приблизительный диапазон символов) через функцию `find_value_diff`.

7. **Запись Excel**  
   Создаётся одна книга: для каждого типа файла — четыре листа (ONE, TWO, MERGE, COMPARE). Применяются жирный заголовок, закрепление панелей, автофильтр, ширина колонок по настройкам.

8. **Параллельность**  
   При `NUM_WORKERS > 1` каждая пара файлов обрабатывается в отдельном процессе; результаты собираются и записываются в один xlsx в основном процессе.

### 2.3 Зависимости

- **Python 3.10+** (стандартная библиотека: `csv`, `logging`, `multiprocessing`, `os`, `sys`, `dataclasses`, `datetime`, `typing`).
- **openpyxl** — для создания и записи xlsx. Если при запуске модуль не найден, выводится сообщение с рекомендацией установить его через conda.

---

## 3. Переменные и функции

### 3.1 Константы и параметры (в начале main.py)

| Имя | Тип | Назначение |
|-----|-----|------------|
| `BASE_DIR` | str | Корневой каталог проекта (каталог, где лежит main.py). |
| `FOLDER_ONE` | str | Относительный путь к каталогу с первым набором CSV (например, `"IN/ONE"`). |
| `FOLDER_TWO` | str | Относительный путь к каталогу со вторым набором CSV (например, `"IN/TWO"`). |
| `CURRENT_FOLDER` | str | `"ONE"` или `"TWO"` — какой каталог считать текущим (старая версия); второй считается новым. |
| `OUT_DIR` | str | Каталог для выходного xlsx (например, `"OUT"`). |
| `LOG_DIR` | str | Каталог для логов (например, `"log"`). |
| `OUTPUT_FILE_PREFIX` | str | Префикс имени выходного файла; к нему добавляется таймштамп. |
| `CSV_ENCODING` | str | Кодировка CSV (по умолчанию `"utf-8"`). |
| `CSV_DELIMITER` | str | Разделитель полей в CSV (по умолчанию `";"`). |
| `COLOR_HEADER_REMOVED_IN_NEW` | str | Цвет заголовка колонки, которая есть только в текущем файле (красный). |
| `COLOR_HEADER_ADDED_IN_NEW` | str | Цвет заголовка колонки, которая есть только в новом файле (салатовый). |
| `NUM_WORKERS` | int | Число процессов для параллельной обработки; 1 — последовательно. |
| `INPUT_FILES` | list[dict] | Список словарей конфигурации по каждому типу файла (см. ниже). |

Элемент списка `INPUT_FILES`:

| Ключ | Назначение |
|------|------------|
| `"file_one"` | Имя CSV-файла в каталоге ONE (FOLDER_ONE). |
| `"file_two"` | Имя CSV-файла в каталоге TWO (FOLDER_TWO). Имена могут совпадать или различаться (например, разные версии одного набора данных). |
| `"sheet"` | Короткое имя листа (без префикса ONE/TWO/MERGE/COMPARE). |
| `"key_columns"` | Список имён колонок, образующих составной ключ. |
| `"max_col_width"` | Максимальная ширина колонки в Excel. |
| `"freeze"` | Закрепление области (например, `"C2"`). |
| `"col_width_mode"` | Режим ширины колонок (например, `"AUTO"`). |
| `"min_col_width"` | Минимальная ширина колонки. |

### 3.2 Функции

| Функция | Назначение и пример использования |
|---------|-----------------------------------|
| `_setup_logging(log_dir)` | Настраивает логгер: файл в `log_dir` с уровнем DEBUG, консоль INFO. Формат строки DEBUG: `дата время - [уровень] - сообщение [def: имя_функции]`. Вызов: `logger = _setup_logging(os.path.join(BASE_DIR, LOG_DIR))`. |
| `_resolve_file_path(base_dir, folder, file_name)` | Ищет файл в `base_dir/folder`: сначала точное имя, затем с расширением .csv/.CSV. Возвращает полный путь или `None`. Пример: `_resolve_file_path(BASE_DIR, "IN/ONE", "CONTEST (PROM) 02-02 v2.csv")`. |
| `load_csv(file_path, encoding, delimiter, logger)` | Читает CSV; возвращает `(headers, list[dict])`. Заголовки — первая строка, каждая следующая строка — словарь по именам колонок. Пример: `headers, data = load_csv(path, logger=logger)`. |
| `make_key(row, key_columns)` | По строке (dict) и списку колонок возвращает кортеж значений ключа. Пример: `k = make_key(row, ["CONTEST_CODE", "GROUP_CODE"])`. |
| `build_index(headers, data, key_columns)` | Строит словарь «ключ → строка» для быстрого поиска. Пример: `idx = build_index(h, data, key_cols)`. |
| `find_value_diff(old_val, new_val)` | Сравнивает две строки и возвращает краткое описание места отличия (например, «целиком» или «приблизительно символы 5–10»). Используется в COMPARE. |
| `process_one_file(config, path_current, path_new, current_folder_name, new_folder_name, key_columns, logger)` | Обрабатывает одну пару файлов: загружает CSV, строит MERGE и список COMPARE. Возвращает объект `MergeCompareResult` с данными для листов ONE, TWO, MERGE, COMPARE и параметрами оформления. |
| `_worker_process_file(args)` | Обёртка для вызова `process_one_file` из пула процессов (без logger). |
| `_write_sheet_data(ws, headers, rows, ...)` | Заполняет лист openpyxl: заголовок (жирный, при необходимости цвет), данные, ширина колонок, закрепление, автофильтр. |
| `_write_compare_sheet(ws, compare_rows, bold_header)` | Заполняет лист COMPARE: колонки key, column, value_current, value_new, location_in_value. |
| `_write_excel_in(...)` | Создаёт xlsx только с исходными данными: для каждого результата — листы ONE и TWO. |
| `_write_excel_merge(...)` | Создаёт xlsx только с листами MERGE. |
| `_write_excel_compare(...)` | Создаёт xlsx только с листами COMPARE. |
| `write_excel_three_files(results, out_path_dir, output_file_prefix, timestamp, current_folder_name, new_folder_name, logger)` | Создаёт три файла: IN_{префикс}_{timestamp}.xlsx, MERGE_..., COMPARE_.... Возвращает кортеж путей к созданным файлам. |
| `main()` | Точка входа: настройка логов, проверка файлов, формирование задач, запуск обработки (последовательно или через Pool), вызов `write_excel_three_files`, возврат кода выхода 0/1. |

### 3.3 Класс MergeCompareResult (dataclass)

Хранит результат обработки одной пары файлов:

- `sheet_name` — базовое имя листа;
- `headers_merge`, `header_flags` — заголовки MERGE и флаги окраски (True — красный, None — салатовый, False — общий);
- `rows_merge` — строки для MERGE;
- `compare_rows` — список записей для COMPARE;
- `max_col_width`, `freeze`, `min_col_width` — параметры оформления;
- `headers_one`, `rows_one`, `headers_two`, `rows_two` — данные для листов ONE и TWO.

---

## 4. Запуск

Из корня проекта:

```bash
python main.py
```

Выходной файл появится в каталоге `OUT` с именем вида:  
`SPOD_PROM_IFT_COMPARE_ГГГГММДД_ЧЧ-ММ.xlsx`.

При отсутствии openpyxl установите его в среде Anaconda:

```bash
conda install openpyxl
```

---

## 5. История версий

| Версия | Изменения |
|--------|-----------|
| 1.0 | Первая версия: загрузка CSV из IN/ONE и IN/TWO, слияние по ключам, листы MERGE и COMPARE, запись одного xlsx в OUT, логирование в log, опциональная многопроцессная обработка. Универсальная работа с любым набором колонок; выделение удалённых/добавленных колонок в MERGE (красный/салатовый заголовок). Поддержка составного ключа и указания места изменения в значении в COMPARE. |

---

## 6. Дополнительные замечания

- **key_columns** должны точно соответствовать названиям колонок в первой строке CSV (с учётом регистра и пробелов). Для файлов с русскими заголовками в конфигурации указываются русские названия колонок.
- Имена листов в Excel ограничены длиной 31 символ; при длинных `sheet` и префиксах может потребоваться сокращение имени в конфигурации.
- Обработка больших файлов (сотни тысяч строк) может занять время; при нехватке памяти можно уменьшить `NUM_WORKERS` до 1 или разбить набор файлов.

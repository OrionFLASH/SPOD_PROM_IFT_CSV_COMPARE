# Сравнение пар CSV-файлов (SPOD PROM IFT CSV Compare)

## 1. Подробное техническое задание (ТЗ)

### 1.1 Цели и назначение программы

Программа **SPOD PROM IFT CSV Compare** предназначена для **попарного сравнения двух наборов табличных данных**, представленных в виде CSV-файлов и разложенных по двум каталогам (**ONE** и **TWO**). Один набор считается **текущим** (исходная, старая или эталонная версия), второй — **новым** (обновлённая версия). Цель — **автоматически выявить расхождения** между наборами, **объединить данные по ключу** в единую таблицу слияния и **задокументировать все изменения** в удобном для просмотра виде (Excel).

Использование: сравнение выгрузок из систем (например, справочники, конфигурации конкурсов/наград/ролей), контроль миграций данных, аудит изменений между двумя версиями одного и того же набора сущностей.

### 1.2 Бизнес-задачи, которые решает программа

1. **Сравнение двух версий одного набора данных**  
   Понять, что изменилось между «старой» (ONE) и «новой» (TWO) выгрузкой: какие строки добавлены, удалены, в каких полях изменены значения.

2. **Единая сводная таблица (MERGE)**  
   Получить одну таблицу по каждому типу данных, в которой собраны все уникальные строки из обоих файлов; для совпадающих по ключу строк в ячейках отображаются значения из нового файла (с возможностью увидеть колонки, которые есть только в одном из файлов).

3. **Явная разметка типа изменения по строке (колонка CHANGE)**  
   В каждой строке MERGE видно: строка только в новом файле (NEW), только в старом (DEL), или в обоих с правками (CHANGE), либо без изменений (**-**).

4. **Детальный отчёт об изменениях (COMPARE)**  
   Для каждого изменения (в т.ч. добавленные и удалённые строки): три строки — ONE (полная строка из текущего файла), TWO (полная строка из нового), CHANGE — **ключ** (привязка к строке) и пометки по колонкам или **DEL** (строка удалена в TWO) / **NEW** (строка новая в TWO).

5. **Сохранение исходных данных и результатов в разных файлах**  
   Исходные загрузки (ONE/TWO), слияние (MERGE) и отчёт об изменениях (COMPARE) формируются в **трёх отдельных Excel-файлах**, чтобы не смешивать сырые данные, сводки и отчёты.

6. **Универсальность по структуре таблиц**  
   Программа не привязана к конкретному набору колонок: конфигурируются имена файлов, ключевые колонки и параметры листов; поддерживается любое число колонок и различие набора колонок между ONE и TWO (с визуальной пометкой в MERGE).

7. **Контроль входных данных**  
   Перед запуском проверяется наличие всех указанных файлов в ONE и TWO; при отсутствии хотя бы одного файла работа останавливается с сообщением, каких файлов не хватает.

8. **Прозрачность выполнения**  
   В консоль выводится ход работы (проверка файлов, обработка пар, запись файлов), чтобы было видно, что программа выполняется и не «зависла».

### 1.3 Входные данные и форматы

- **Расположение:** два каталога относительно корня проекта — `IN/ONE` и `IN/TWO` (имена задаются в параметрах `FOLDER_ONE`, `FOLDER_TWO`).
- **Формат файлов:** CSV с разделителем **точка с запятой** (`;`), кодировка **UTF-8**.
- **Структура:** первая строка — заголовки (названия колонок), остальные строки — данные. Количество и имена колонок могут быть любыми; для каждой пары файлов в конфигурации задаётся список колонок **key_columns**, по которым строится составной ключ строки.
- **Имена файлов:** для каждой логической пары в конфигурации задаются два имени — **file_one** (файл в ONE) и **file_two** (файл в TWO). Имена могут совпадать (одно и то же имя в обоих каталогах) или различаться (например, разные версии: `v1.csv` и `v2.csv`).
- **Поиск файлов:** при отсутствии файла с точным именем выполняется поиск по тому же имени с расширением `.csv` или `.CSV`.

### 1.4 Выходные артефакты

Все выходные файлы создаются в каталоге **OUT**. Имя каждого файла: **{тип}_{префикс}_{таймштамп}.xlsx**, где:
- **тип** — `IN`, `MERGE` или `COMPARE`;
- **префикс** — задаётся параметром `OUTPUT_FILE_PREFIX` (например, `SPOD_PROM_IFT_COMPARE`);
- **таймштамп** — дата и время в формате `ГГГГММДД_ЧЧ-ММ` (год, месяц, день, час, минута).

**1) IN_{префикс}_{таймштамп}.xlsx** — исходные загруженные данные  
- Для каждой пары файлов из конфигурации — два листа: **«{sheet} ONE»** и **«{sheet} TWO»**.
- На листах — данные «как есть» из соответствующего CSV (ONE или TWO): те же заголовки и строки.
- Назначение: архив загруженных выгрузок, возможность сверить исходники без повторного чтения CSV.

**2) MERGE_{префикс}_{таймштамп}.xlsx** — слияние по ключу  
- Для каждой пары — один лист **«MERGE {sheet}»**.
- На листе:
  - Объединённое множество **уникальных ключей** из обоих файлов (ключ = кортеж значений колонок из `key_columns`).
  - Для каждого ключа — одна строка: сначала берутся значения из текущего файла (ONE или TWO в зависимости от `CURRENT_FOLDER`), затем значения из нового файла подставляются поверх там, где ключ есть в новом файле.
  - Все колонки из текущего файла + все колонки, которые есть только в новом. Колонки только из текущего в заголовке выделяются **красным**, только из нового — **салатовым**.
  - В конце листа добавлена колонка **CHANGE**:
    - **NEW** — ключа не было в текущем файле (ONE), строка есть только в новом (TWO);
    - **DEL** — ключ был в текущем (ONE), в новом (TWO) его нет;
    - **CHANGE** — ключ есть в обоих файлах и по этой строке были изменения хотя бы в одной колонке;
    - **-** — ключ в обоих файлах, изменений нет.
- Заголовок — жирный, включён автофильтр, закрепление панелей задаётся параметром `freeze` для каждого типа листа.

**3) COMPARE_{префикс}_{таймштамп}.xlsx** — список изменений  
- Для каждой пары — один лист **«COMPARE {sheet}»**.
- На листе для **каждого изменения** (ключ с правками, только в ONE — удалён в TWO, или только в TWO — новый) выводятся **три строки**:
  1. **ONE** — ключ и все значения из текущего файла (полная строка; для NEW — пусто);
  2. **TWO** — тот же ключ и все значения из нового файла (полная строка; для DEL — пусто);
  3. **CHANGE** — **ключ** (значения ключевых колонок, чтобы было понятно, к какой строке относится) и: пометки по колонкам (что поменялось), либо **DEL** (строка удалена в TWO), либо **NEW** (строка новая в TWO).
- Колонки листа: **№** (порядковый номер), **откуда** (ONE / TWO / CHANGE), затем все колонки из MERGE.
- Назначение: детальный разбор всех изменений без просмотра всего MERGE.

### 1.5 Логика обработки (алгоритмические требования)

1. **Проверка наличия файлов**  
   Для каждой записи в `INPUT_FILES` проверяется наличие файла `file_one` в каталоге ONE и файла `file_two` в каталоге TWO. Если хотя бы один файл отсутствует — в лог и в консоль выводится список отсутствующих (каталог + имя файла), программа завершается с кодом 1. При наличии всех файлов — продолжение.

2. **Загрузка CSV**  
   Чтение в UTF-8, разделитель `;`. Первая строка — заголовки, каждая следующая — строка данных (словарь по именам колонок).

3. **Построение ключа**  
   Для каждой строки ключ = кортеж значений по колонкам `key_columns`. Уникальность строки в MERGE и принадлежность к ONE/TWO определяется по этому ключу.

4. **Слияние (MERGE)**  
   Множество ключей = объединение ключей из текущего и нового файла. Для каждого ключа: строка = данные из текущего файла; для каждой колонки из нового файла значение подставляется поверх, если ключ есть в новом файле. Одновременно фиксируются пары (ключ, колонка, старое значение, новое значение) для COMPARE и множество ключей с хотя бы одним изменением — для колонки CHANGE.

5. **Формирование COMPARE**  
   В COMPARE попадают: (1) ключи с изменением значений колонок — блок ONE, TWO, CHANGE с пометками по колонкам; (2) ключи только в ONE (удалены в TWO) — блок с пометкой DEL и ключом в третьей строке; (3) ключи только в TWO (новые) — блок с пометкой NEW и ключом. В третьей строке (CHANGE) всегда выводятся значения ключа для привязки к строке.

6. **Запись Excel**  
   Три отдельные книги: только листы ONE/TWO (IN), только MERGE, только COMPARE. Оформление: жирный заголовок, автофильтр, закрепление и ширина колонок по настройкам для каждого типа листа.

7. **Параллельность**  
   При `NUM_WORKERS > 1` каждая пара файлов обрабатывается в отдельном процессе; результаты собираются в основном процессе и записываются в три файла. При `NUM_WORKERS <= 1` обработка последовательная с пошаговым выводом в консоль по каждой паре.

### 1.6 Функциональные требования (сводка)

| № | Требование |
|---|------------|
| Ф1 | Загрузка CSV из двух каталогов (ONE, TWO) по списку пар файлов из конфигурации. |
| Ф2 | Поддержка разных имён файлов в ONE и TWO для одной логической пары (file_one, file_two). |
| Ф3 | Проверка наличия всех указанных файлов перед стартом; остановка с сообщением при отсутствии файлов. |
| Ф4 | Универсальная работа с любым набором колонок; составной ключ задаётся списком key_columns. |
| Ф5 | MERGE: объединение всех уникальных ключей, подстановка значений из нового файла поверх текущего. |
| Ф6 | MERGE: колонка CHANGE в конце листа со значениями NEW / DEL / CHANGE / **-** (без изменений). |
| Ф7 | MERGE: визуальная пометка колонок только из текущего (красный заголовок) и только из нового (салатовый). |
| Ф8 | COMPARE: для каждого изменения три строки (ONE, TWO, CHANGE); в третьей строке — ключ и пометки по колонкам или DEL/NEW. |
| Ф9 | Три выходных файла: IN (исходные ONE/TWO), MERGE (слияние), COMPARE (изменения). |
| Ф10 | Логирование в файл (DEBUG) и консоль (INFO); пошаговый вывод в консоль при работе (прогресс, запись файлов). |

### 1.7 Нефункциональные и технические требования

- **Среда:** Python 3.10+, зависимости — только стандартная библиотека и модули, поставляемые с Python/Anaconda; установка пакетов через `pip` на целевой системе не предполагается. Для записи xlsx используется **openpyxl** (при отсутствии — установка через `conda install openpyxl`).
- **Кодировка и формат CSV:** UTF-8, разделитель `;`, первая строка — заголовки.
- **Документация и код:** комментарии и документация на русском языке; аннотации типов в коде.
- **Репозиторий:** каталоги IN, OUT, log/LOGS не попадают в репозиторий (указаны в `.gitignore`).

### 1.8 Ограничения и допущения

- Имена листов в Excel ограничены 31 символом; при длинных именах sheet и префиксах может потребоваться сокращение в конфигурации.
- Очень большие файлы (сотни тысяч строк) могут требовать значительного времени и памяти; при нехватке ресурсов рекомендуется уменьшить `NUM_WORKERS` до 1 или сократить список пар.
- Значения ячеек в Excel ограничены по длине (порядка 32 К символов); при необходимости длинные значения обрезаются при записи.
- Колонки `key_columns` должны в точности совпадать с названиями колонок в первой строке CSV (с учётом регистра и пробелов).

---

## 2. Краткое описание (назначение и результат)

### 2.1 Назначение

Программа предназначена для попарного сравнения CSV-файлов из двух каталогов (**ONE** и **TWO**). Один каталог считается **текущим** (старая версия), второй — **новым** (обновлённая). Результат — **три** Excel-файла в каталоге **OUT**:

1. **IN_{префикс}_{таймштамп}.xlsx** — исходные данные (листы ONE и TWO по каждой паре).
2. **MERGE_{префикс}_{таймштамп}.xlsx** — слияние по ключу с колонкой CHANGE (NEW / DEL / CHANGE / **-**).
3. **COMPARE_{префикс}_{таймштамп}.xlsx** — список изменений: три строки на каждое изменение (ONE, TWO, CHANGE с ключом и пометками или DEL/NEW).

Входные CSV: разделитель `;`, UTF-8, первая строка — заголовки. Программа универсальна по набору колонок; удалённые/добавленные колонки в MERGE выделяются красным/салатовым. Заголовки — жирные, автофильтр и закрепление задаются в конфигурации.

---

## 3. Подробное описание решения

### 3.1 Структура проекта

- **main.py** — единственный исполняемый файл: конфигурация, загрузка CSV, слияние по ключам, сравнение, запись Excel, логирование, при необходимости — многопроцессная обработка.
- **IN/ONE**, **IN/TWO** — каталоги с исходными CSV (имена файлов задаются в `INPUT_FILES`).
- **OUT** — каталог для сгенерированных xlsx (три файла: IN, MERGE, COMPARE).
- **log** — каталог для логов (формат имени: `DEBUG_compare_ГГГГММДД_ЧЧ.log`).

### 3.2 Алгоритм

1. **Параметры**  
   В начале `main.py` задаются: `BASE_DIR`, `FOLDER_ONE`, `FOLDER_TWO`, `CURRENT_FOLDER` (какой каталог считать текущим), `OUT_DIR`, `LOG_DIR`, `OUTPUT_FILE_PREFIX`, список `INPUT_FILES` (для каждого файла: имя, лист, ключевые колонки, ширина колонок, закрепление и т.д.).

2. **Поиск файлов**  
   Для каждой пары из `INPUT_FILES` ищется файл `file_one` в каталоге ONE и файл `file_two` в каталоге TWO. Имена могут различаться (например, старая и новая версия одного набора). Поддерживается разный регистр расширения (`.csv` / `.CSV`).

3. **Загрузка CSV**  
   Чтение в кодировке UTF-8, разделитель `;`. Первая строка — заголовки, остальные — строки данных (словарь по именам колонок).

4. **Ключ строки**  
   По полям `key_columns` строится кортеж значений — составной ключ. Уникальность строки в MERGE определяется по этому ключу.

5. **Слияние (MERGE)**  
   Объединяются все ключи из текущего и нового файла. Для каждого ключа берётся строка из текущего файла, затем для каждой колонки из нового файла значение подставляется поверх (если есть в новом). Колонки только из текущего файла в заголовке MERGE выделяются красным; только из нового — салатовым.

6. **Сравнение (COMPARE)**  
   В COMPARE попадают ключи с изменёнными колонками (ONE, TWO, третья строка CHANGE с ключом и пометками), ключи только в ONE (DEL, с ключом в третьей строке), ключи только в TWO (NEW, с ключом). Для текстовых отличий делается попытка указать место изменения через `find_value_diff`.

7. **Запись Excel**  
   Создаются три книги: IN (листы ONE, TWO), MERGE (листы MERGE), COMPARE (листы COMPARE). Применяются жирный заголовок, закрепление панелей, автофильтр, ширина колонок по настройкам.

8. **Параллельность**  
   При `NUM_WORKERS > 1` каждая пара файлов обрабатывается в отдельном процессе; результаты собираются и записываются в один xlsx в основном процессе.

### 3.3 Зависимости

- **Python 3.10+** (стандартная библиотека: `csv`, `logging`, `multiprocessing`, `os`, `sys`, `dataclasses`, `datetime`, `typing`).
- **openpyxl** — для создания и записи xlsx. Если при запуске модуль не найден, выводится сообщение с рекомендацией установить его через conda.

---

## 4. Переменные и функции

### 4.1 Константы и параметры (в начале main.py)

| Имя | Тип | Назначение |
|-----|-----|------------|
| `BASE_DIR` | str | Корневой каталог проекта (каталог, где лежит main.py). |
| `FOLDER_ONE` | str | Относительный путь к каталогу с первым набором CSV (например, `"IN/ONE"`). |
| `FOLDER_TWO` | str | Относительный путь к каталогу со вторым набором CSV (например, `"IN/TWO"`). |
| `CURRENT_FOLDER` | str | `"ONE"` или `"TWO"` — какой каталог считать текущим (старая версия); второй считается новым. |
| `OUT_DIR` | str | Каталог для выходного xlsx (например, `"OUT"`). |
| `LOG_DIR` | str | Каталог для логов (например, `"log"`). |
| `OUTPUT_FILE_PREFIX` | str | Префикс имени выходного файла; к нему добавляется таймштамп. |
| `CSV_ENCODING` | str | Кодировка CSV (по умолчанию `"utf-8"`). |
| `CSV_DELIMITER` | str | Разделитель полей в CSV (по умолчанию `";"`). |
| `COLOR_HEADER_REMOVED_IN_NEW` | str | Цвет заголовка колонки, которая есть только в текущем файле (красный). |
| `COLOR_HEADER_ADDED_IN_NEW` | str | Цвет заголовка колонки, которая есть только в новом файле (салатовый). |
| `NUM_WORKERS` | int | Число процессов для параллельной обработки; 1 — последовательно. |
| `INPUT_FILES` | list[dict] | Список словарей конфигурации по каждому типу файла (см. ниже). |

Элемент списка `INPUT_FILES`:

| Ключ | Назначение |
|------|------------|
| `"file_one"` | Имя CSV-файла в каталоге ONE (FOLDER_ONE). |
| `"file_two"` | Имя CSV-файла в каталоге TWO (FOLDER_TWO). Имена могут совпадать или различаться (например, разные версии одного набора данных). |
| `"sheet"` | Короткое имя листа (без префикса ONE/TWO/MERGE/COMPARE). |
| `"key_columns"` | Список имён колонок, образующих составной ключ. |
| `"max_col_width"` | Максимальная ширина колонки в Excel. |
| `"freeze"` | Закрепление области (например, `"C2"`). |
| `"col_width_mode"` | Режим ширины колонок (например, `"AUTO"`). |
| `"min_col_width"` | Минимальная ширина колонки. |

### 4.2 Функции

| Функция | Назначение и пример использования |
|---------|-----------------------------------|
| `_setup_logging(log_dir)` | Настраивает логгер: файл в `log_dir` с уровнем DEBUG, консоль INFO. Формат строки DEBUG: `дата время - [уровень] - сообщение [def: имя_функции]`. Вызов: `logger = _setup_logging(os.path.join(BASE_DIR, LOG_DIR))`. |
| `_resolve_file_path(base_dir, folder, file_name)` | Ищет файл в `base_dir/folder`: сначала точное имя, затем с расширением .csv/.CSV. Возвращает полный путь или `None`. Пример: `_resolve_file_path(BASE_DIR, "IN/ONE", "CONTEST (PROM) 02-02 v2.csv")`. |
| `load_csv(file_path, encoding, delimiter, logger)` | Читает CSV; возвращает `(headers, list[dict])`. Заголовки — первая строка, каждая следующая строка — словарь по именам колонок. Пример: `headers, data = load_csv(path, logger=logger)`. |
| `make_key(row, key_columns)` | По строке (dict) и списку колонок возвращает кортеж значений ключа. Пример: `k = make_key(row, ["CONTEST_CODE", "GROUP_CODE"])`. |
| `build_index(headers, data, key_columns)` | Строит словарь «ключ → строка» для быстрого поиска. Пример: `idx = build_index(h, data, key_cols)`. |
| `find_value_diff(old_val, new_val)` | Сравнивает две строки и возвращает краткое описание места отличия (например, «целиком» или «приблизительно символы 5–10»). Используется в COMPARE. |
| `process_one_file(config, path_current, path_new, current_folder_name, new_folder_name, key_columns, logger)` | Обрабатывает одну пару файлов: загружает CSV, строит MERGE и список COMPARE. Возвращает объект `MergeCompareResult` с данными для листов ONE, TWO, MERGE, COMPARE и параметрами оформления. |
| `_worker_process_file(args)` | Обёртка для вызова `process_one_file` из пула процессов (без logger). |
| `_write_sheet_data(ws, headers, rows, ...)` | Заполняет лист openpyxl: заголовок (жирный, при необходимости цвет), данные, ширина колонок, закрепление, автофильтр. |
| `_write_compare_sheet(ws, compare_groups, headers_merge, key_columns, bold_header, logger)` | Заполняет лист COMPARE: для каждого изменения три строки (ONE, TWO, CHANGE); в третьей строке — ключ и пометки по колонкам или DEL/NEW. |
| `_write_excel_in(...)` | Создаёт xlsx только с исходными данными: для каждого результата — листы ONE и TWO. |
| `_write_excel_merge(...)` | Создаёт xlsx только с листами MERGE. |
| `_write_excel_compare(...)` | Создаёт xlsx только с листами COMPARE. |
| `write_excel_three_files(results, out_path_dir, output_file_prefix, timestamp, current_folder_name, new_folder_name, logger)` | Создаёт три файла: IN_{префикс}_{timestamp}.xlsx, MERGE_..., COMPARE_.... Возвращает кортеж путей к созданным файлам. |
| `main()` | Точка входа: настройка логов, проверка файлов, формирование задач, запуск обработки (последовательно или через Pool), вызов `write_excel_three_files`, возврат кода выхода 0/1. |

### 4.3 Класс MergeCompareResult (dataclass)

Хранит результат обработки одной пары файлов:

- `sheet_name` — базовое имя листа;
- `headers_merge`, `header_flags` — заголовки MERGE и флаги окраски (True — красный, None — салатовый, False — общий);
- `rows_merge` — строки для MERGE;
- `compare_rows` — список записей изменений (ключ, колонка, старое/новое значение); `compare_groups` — группы по ключу для вывода в 3 строки (ONE, TWO, CHANGE), включая DEL и NEW; `key_columns` — ключевые колонки для вывода ключа в COMPARE;
- `max_col_width`, `freeze`, `min_col_width` — параметры оформления;
- `headers_one`, `rows_one`, `headers_two`, `rows_two` — данные для листов ONE и TWO.

---

## 5. Запуск

Из корня проекта:

```bash
python main.py
```

В каталоге `OUT` появятся три файла с именами вида:  
`IN_SPOD_PROM_IFT_COMPARE_ГГГГММДД_ЧЧ-ММ.xlsx`,  
`MERGE_SPOD_PROM_IFT_COMPARE_ГГГГММДД_ЧЧ-ММ.xlsx`,  
`COMPARE_SPOD_PROM_IFT_COMPARE_ГГГГММДД_ЧЧ-ММ.xlsx`.

При отсутствии openpyxl установите его в среде Anaconda:

```bash
conda install openpyxl
```

---

## 6. История версий

| Версия | Изменения |
|--------|-----------|
| 1.0 | Первая версия: загрузка CSV из IN/ONE и IN/TWO, слияние по ключам, листы MERGE и COMPARE, запись одного xlsx в OUT, логирование, опциональная многопроцессная обработка. Универсальная работа с любым набором колонок; выделение удалённых/добавленных колонок в MERGE (красный/салатовый). Составной ключ; место изменения в значении в COMPARE. |
| 1.1 | Три выходных файла: IN (исходные ONE/TWO), MERGE, COMPARE. Колонка CHANGE в MERGE (NEW/DEL/CHANGE/**-**). COMPARE: три строки на изменение, в третьей строке — ключ и пометки или DEL/NEW. Проверка файлов перед стартом. Вывод прогресса в консоль. |
| 1.2 | MERGE: при отсутствии изменений в колонке CHANGE выводится «-». Документация обновлена (ТЗ, COMPARE с ключом, DEL, NEW). |

---

## 7. Дополнительные замечания

- **key_columns** должны точно соответствовать названиям колонок в первой строке CSV (с учётом регистра и пробелов). Для файлов с русскими заголовками в конфигурации указываются русские названия колонок.
- Имена листов в Excel ограничены длиной 31 символ; при длинных `sheet` и префиксах может потребоваться сокращение имени в конфигурации.
- Обработка больших файлов (сотни тысяч строк) может занять время; при нехватке памяти можно уменьшить `NUM_WORKERS` до 1 или разбить набор файлов.
